## 平台启动与停止（一键脚本）

本仓库不是单体工程，平台由三部分组成：

- **前端**：`art-design-pro`（Vite / pnpm）
- **后端**：`vue-fastapi-admin-main`（FastAPI / Tortoise / Aerich）
- **生成引擎**：`ComfyUI-master-fitow`（由后端按“项目”按需拉起实例）

为了便于本机联调，这里提供 `docs/scripts/` 下的一键启动/停止脚本。

### 1) 准备环境变量文件

在 `docs/` 目录下复制示例文件并按需修改：

```bash
cd /home/admin1/ai02/codeyard/wk_codeyard/Code_backup/ComfulUI/docs
cp .env.platform.example .env.platform
```

重点关注：

- **路径类**：`ART_FRONTEND_DIR`、`BACKEND_DIR`、`COMFYUI_REPO_PATH`
- **端口类**：`FRONTEND_PORT`（默认 3006）、`BACKEND_PORT`（默认 9999）
- **Python**：`BACKEND_PY`（datagen-backend）、`COMFYUI_PYTHON`（datagen-comfyui）
- **ComfyUI CPU**：`COMFYUI_FORCE_CPU=true`（CPU-only torch 必开，否则 ComfyUI 会因 CUDA 初始化报错）
- **回调写日志（可选）**：`PLATFORM_INTERNAL_SECRET`、`PLATFORM_CALLBACK_URL`

### 2) 启动平台（前端 + 后端）

```bash
cd /home/admin1/ai02/codeyard/wk_codeyard/Code_backup/ComfulUI/docs
chmod +x scripts/*.sh
./scripts/start_all.sh
```

启动成功后默认访问：

- 前端：`http://127.0.0.1:3006`
- 后端：`http://127.0.0.1:9999`
- 后端 API 文档：`http://127.0.0.1:9999/docs`

如果需要**局域网其它机器访问**：

- 将 `docs/.env.platform` 中 `FRONTEND_HOST` / `BACKEND_HOST` 设置为 `0.0.0.0`
- 然后用服务器的局域网 IP 访问，例如：`http://10.10.1.199:3006`

### 3) 查看状态 / 日志

```bash
cd /home/admin1/ai02/codeyard/wk_codeyard/Code_backup/ComfulUI/docs
./scripts/status.sh
```

日志默认输出到：

- `docs/runtime/logs/backend.log`
- `docs/runtime/logs/frontend.log`

### 4) 停止平台

```bash
cd /home/admin1/ai02/codeyard/wk_codeyard/Code_backup/ComfulUI/docs
./scripts/stop_all.sh
```

### 5) ComfyUI 的启动方式说明

- **推荐**：通过后端 `POST /api/projects/{id}/open_comfy` 按项目拉起（并复用）实例，实例端口来自 `COMFYUI_PORT_RANGE`。
- **日志采集**：
  - 后端后台任务会轮询 `GET {comfy_url}/history`，将新 `prompt_id` 去重写入 `generation_logs`
  - 如配置 `PLATFORM_INTERNAL_SECRET`，可在 ComfyUI 工作流末尾使用自定义节点 **Platform Callback (HTTP)** 调用 `PLATFORM_CALLBACK_URL` 直接回调写日志（Header：`X-Platform-Secret`）

