# 数据生成平台前后端协同开发规范

本文基于以下资料整理：
- 需求文档：`数据生成平台系统概述.docx`
- 前端框架官方文档：`https://www.artd.pro/docs/zh/guide/introduce.html`、`https://www.artd.pro/docs/zh/guide/quick-start.html`
- 前端项目源码：`art-design-pro`
- 后端项目源码：`vue-fastapi-admin-main`

---

## 1. 事实依据矩阵（证据-结论映射）

| 主题 | 结论 | 依据类型 | 出处 |
|---|---|---|---|
| 前端定位 | 采用 Vue3 + TS + Vite + Element Plus 的后台模板能力 | 官方文档 | `https://www.artd.pro/docs/zh/guide/introduce.html` |
| 前端工程效率 | 推荐使用 `useTable`、`ArtForm`、`ArtSearchBar` 进行业务开发 | 官方文档+源码 | `https://www.artd.pro/docs/zh/guide/introduce.html`；`art-design-pro/src/components/core/forms` |
| 前端鉴权守卫 | 登录态由 `userStore.isLogin` 与路由前置守卫联合控制 | 源码事实 | `art-design-pro/src/router/guards/beforeEach.ts` |
| 前端请求鉴权 | 请求拦截器把 token 注入请求头，401 自动触发登出 | 源码事实 | `art-design-pro/src/utils/http/index.ts` |
| 前端权限 | 支持 `v-roles`、`v-auth`、`hasAuth` 三类权限控制 | 源码事实 | `art-design-pro/src/directives/core/roles.ts`、`art-design-pro/src/directives/core/auth.ts`、`art-design-pro/src/hooks/core/useAuth.ts` |
| 后端鉴权 | JWT 鉴权通过 `AuthControl.is_authed` 依赖注入 | 源码事实 | `vue-fastapi-admin-main/app/core/dependency.py` |
| 后端 RBAC | 用户-角色-菜单/API 关系决定访问能力 | 源码事实 | `vue-fastapi-admin-main/app/models/admin.py`、`vue-fastapi-admin-main/app/core/dependency.py` |
| 后端响应规范 | 统一返回 `Success/Fail/SuccessExtra` 结构 | 源码事实 | `vue-fastapi-admin-main/app/schemas/base.py` |
| 后端数据库迁移 | 使用 Aerich 迁移，配置在 `pyproject.toml` | 源码事实 | `vue-fastapi-admin-main/pyproject.toml`、`vue-fastapi-admin-main/app/core/init_app.py` |
| PostgreSQL 异步连接 | 框架已给出 `asyncpg` 配置模板，可切换默认连接 | 源码事实 | `vue-fastapi-admin-main/app/settings/config.py` |
| 需求接口方向 | 认证、项目、ComfyUI、日志、统计、导出、监控是核心 API 组 | 需求事实 | `数据生成平台系统概述.docx` |

---

## 2. 登录鉴权规范（前后端统一）

### 2.1 前端规范
- 登录成功后只通过统一入口写入登录态：`setToken` + `setLoginStatus(true)`，避免多处散写（见 `user.ts` 与登录页调用链）。
- 路由访问必须经前置守卫：未登录访问受保护页面时跳转登录并携带 `redirect` 参数（见 `beforeEach.ts`）。
- 所有请求通过统一 HTTP 封装发送，禁止页面内直接 `axios`，确保 token、错误码处理一致（见 `utils/http/index.ts`）。
- 401 场景统一走拦截器登出，页面层不重复实现“过期处理”。

### 2.2 后端规范
- 受保护接口使用依赖注入鉴权：`dependencies=[DependAuth]` 或路由组级注入（见 `base.py`、`v1/__init__.py`）。
- token 生成与解析统一在 JWT 工具和鉴权依赖中处理（见 `jwt_utils.py`、`dependency.py`）。
- 密码必须哈希存储，使用 Argon2（见 `utils/password.py`）。

### 2.3 与需求对齐
- 需求要求“前端 Header 携带 Authorization: Bearer <token>，后端依赖注入校验”。
- 当前前端封装默认写入 `Authorization`，后端模板默认从 `token` 头读取。落地时需统一为单一协议（建议 Bearer），并在前后端同时改造。

---

## 3. 权限分配规范（路由、按钮、接口三级）

### 3.1 前端权限规范
- 路由/菜单权限：动态菜单加载后注册路由，进入页面前做路径可达性校验（`RoutePermissionValidator`）。
- 角色级权限：`v-roles` 适合“是否可见”类粗粒度控制。
- 按钮/操作级权限：
  - 后端模式：`v-auth` / `hasAuth` 基于 `route.meta.authList`。
  - 前端模式：`hasAuth` 基于用户 `buttons`。

### 3.2 后端权限规范
- 所有业务路由默认挂 `DependPermission`（见 `app/api/v1/__init__.py`）。
- 权限判定依据 `(method, path)` 是否存在于当前用户角色授权 API 集合（见 `PermissionControl.has_permission`）。
- 角色维护需同步菜单与 API 两侧关系（见 `controllers/role.py` 的角色更新逻辑）。

### 3.3 与需求对齐
- 需求提出“项目所有人可操作 ComfyUI，非所有人 403”：
  - 后端：除 RBAC 外，`open_comfy` 需增加资源级校验（project/service owner check）。
  - 前端：按钮禁用只是体验优化，最终以后端 403 为准。

---

## 4. API 设计规范（RESTful + 统一响应）

### 4.1 基础规范
- 统一响应包裹：`{ code, msg, data }`；分页扩展 `total/page/page_size`（见 `schemas/base.py`）。
- 列表接口统一分页参数与过滤参数；创建/更新输入使用 Pydantic schema。
- 错误语义清晰：401 未认证、403 无权限、400 参数问题、500 系统错误。

### 4.2 推荐接口分组（按需求）
- 认证：`POST /api/auth/register`、`POST /api/auth/login`、`GET /api/auth/userinfo`
- 项目：`POST /api/projects`、`GET /api/projects`、`PUT /api/projects/{id}`、`DELETE /api/projects/{id}`
- ComfyUI：`POST /api/projects/{id}/open_comfy`、`GET /api/comfy/services`、`POST /api/comfy/services/health-check`
- 生成日志：`POST /api/logs`、`GET /api/logs`
- 统计：`GET /api/stats`、`GET /api/export`
- 监控：`GET /api/server/stats`

### 4.3 与框架契合点
- 后端可复用 `CRUDBase` 快速搭建标准资源接口。
- 前端按 `src/api/*.ts` 模式封装请求函数，页面只调用 API 方法，不直接拼 URL。

---

## 5. 数据库设计规范（PostgreSQL 异步）

### 5.1 基础约定
- 使用 Tortoise ORM 模型，继承 `BaseModel` + `TimestampMixin`（统一 `id/created_at/updated_at`）。
- PostgreSQL 使用 `tortoise.backends.asyncpg`（见 `settings/config.py` 模板）。
- 迁移流程固定：`aerich migrate` -> `aerich upgrade`。

### 5.2 需求实体建议
- `projects`：项目主数据（name/code/note/owner_user_id/create_time）
- `comfyui_services`：用户-项目-端口-状态-心跳
- `generation_logs`：生成记录（user_id/project_id/timestamp/status/concurrent_id/details）
- 可选扩展：
  - `generation_tasks`（任务生命周期）
  - `generation_results`（结果文件元数据）

### 5.3 索引与约束
- 高频查询字段加索引：`user_id`、`project_id`、`status`、`timestamp`。
- 唯一性建议：
  - `projects.code` 唯一
  - `(user_id, project_id)` 在 `comfyui_services` 上唯一（保障单项目单服务）
- 资源级权限依赖外键/逻辑关联，不依赖前端传 user_id 作为可信身份源。

---

## 6. 表单设计规范（ArtForm/Element Plus 实践）

### 6.1 设计原则
- 字段定义驱动：用 `items` 配置描述字段、组件类型、props、校验规则。
- 搜索与编辑分离：搜索使用 `ArtSearchBar`，新增/编辑使用 `ArtForm`。
- 所有提交前执行 `validate`，校验失败阻断请求。
- 提交按钮与重置按钮行为统一，由组件事件 `submit/reset` 对外抛出。

### 6.2 需求场景规范
- 注册/登录：必填校验（用户名、邮箱、密码），密码强度建议使用 `validator.ts` 规则。
- 新建项目：字段为 `name/code/note`；`create_time` 后端生成，前端不填。
- 统计筛选：时间范围、项目、用户、维度（day/project/user），并保持可复现查询参数。
- 监控页面：只读展示，不提供“开关机/重启”操作控件。

---

## 7. 需求到实现的增量改造清单

### 7.1 后端增量
- 新增模型与 schema：`projects`、`comfyui_services`、`generation_logs`。
- 新增控制器与路由模块：
  - `app/controllers/projects.py`、`app/api/v1/projects/projects.py`
  - `app/controllers/comfyui.py`、`app/api/v1/comfyui/comfyui.py`
  - `app/controllers/logs.py`、`app/api/v1/logs/logs.py`
  - `app/api/v1/stats/stats.py`、`app/api/v1/server/server.py`
- 为新增路由挂载 `DependPermission`，并补充 owner-level 检查。
- 接入 ComfyUI 通信层（建议 service 层封装），避免在路由函数中直接 `subprocess`。

### 7.2 前端增量
- 页面：
  - 登录/注册（如需对齐需求的注册能力）
  - 个人工作台（项目卡片 + 状态）
  - 统计看板（图表 + 表格 + 导出）
  - 服务器监控（只读指标）
- API 封装：
  - `src/api/project.ts`、`src/api/comfy.ts`、`src/api/logs.ts`、`src/api/stats.ts`、`src/api/server.ts`
- 权限与交互：
  - “数据生成”按钮按权限控制显示/禁用
  - open_comfy 成功后跳转或新标签打开 `comfy_url`
  - 403/401 统一提示（依赖全局请求封装）

---

## 8. 明确边界（避免误判）

- 官方文档可直接确认内容：框架定位、技术栈、快速开始与组件能力方向。
- 细粒度工程规则（鉴权/权限/请求实现细节）主要来自本地源码事实，不属于官方页面显式规范。
- 因此本规范中每条规则都区分了“官方可证实”与“源码实践建议”，满足可追溯与事实准确要求。

