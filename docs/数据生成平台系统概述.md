## 数据生成平台系统概述

数据生成平台基于 Vue3 + Element Plus/Ant Design Pro 构建前端，后端采用 vue-fastapi-admin-main框架的后端部分，数据库使用 PostgreSQL（异步连接）。系统架构如下：用户通过前端界面进行操作，前端调用后端提供的 RESTful API；后端负责处理业务逻辑，并与 ComfyUI 服务进行通信，最终将结果反馈给前端；数据库记录用户、项目、ComfyUI 服务状态和生成日志等信息，前端根据需要展示统计图表和数据。整体流程为：用户 → 前端界面 → 后端 API → （必要时）ComfyUI → 后端 → 前端展现结果。

前端框架开发文档：https://www.artd.pro/docs/zh/guide/introduce.html，后端采用 vue-fastapi-admin-main框架的后端部分，后端项目地址：https://github.com/mizhexiaoxiao/vue-fastapi-admin，数据库使用 PostgreSQL（异步连接）。

### 用户管理模块

注册流程：用户在前端填写用户名、邮箱和密码后，前端调用 POST /api/auth/register 接口提交注册信息。后端验证输入并在用户表（包含用户ID、用户名、邮箱、密码哈希等字段）中创建新用户，返回操作结果（例如 {"code":0,"message":"注册成功","data":{"userId":...}}）。前端根据返回状态提示用户注册成功或失败。

登录流程：用户填写用户名和密码后调用 POST /api/auth/login 接口。后端验证凭据，成功则生成 JWT Token 或 Session，并返回 { "code":0, "data": { "token": "...", "userId": ... } }。前端保存该 token（如保存在 localStorage），并将用户状态设为已登录，同时跳转到个人工作台。失败则提示错误信息。

接口保护：所有需要登录的 API（如项目创建、ComfyUI 服务操作等）都需验证 JWT Token。前端在发起请求时在 Header 中附加 Authorization: Bearer <token>，后端通过 FastAPI 依赖注入自动校验用户身份，从而确保接口安全。

状态更新：登录成功后，前端使用 Vuex 或全局状态管理保存用户信息（如 userId）。每次调用后端接口时携带 token，后端根据 token 自动识别当前用户，前端界面据此调整显示（如显示用户名、显示用户可操作的项目等）。

### 个人工作台

#### 项目管理模块

新建项目：

在个人工作台界面，用户点击“新建项目”，弹出输入框。需要输入的字段有：项目名称、项目号、备注。其中，创建日期由后端自动生成无需输入。

用户填写信息后，前端调用接口 POST /api/projects，请求体示例：

{ "name": "项目A", "code": "PRJ-001", "note": "项目备注" }

后端接收请求，验证数据后在 projects 表中插入一条记录，字段包括：id, name, code, note, owner_user_id, create_time（其中 create_time 由后端自动设置）。返回新项目的完整信息，例如：

{
  "code": 0,
  "data": { "id": 123, "name": "项目A", "code": "PRJ-001", "note": "项目备注", "create_time": "2025-09-28 10:00:00" }
}

前端收到响应后，将新项目加入项目列表，并在列表上显示相应的项目卡片。

项目列表：

用户登录后，前端调用 GET /api/projects 获取所有项目列表。后端从数据库查询项目表，返回项目数组，例如：

{
  "code": 0,
  "data": [
    { "id": 123, "name": "项目A", "code": "PRJ-001", "note": "...", "owner_user_id": 10, "create_time": "2025-09-28 10:00:00" },
    { "id": 124, "name": "项目B", "code": "PRJ-002", ... },
    ...
  ]
}

前端根据返回数据渲染项目卡片，每个卡片展示项目基本信息（名称、项目号、创建时间、备注）。卡片上包含一个“数据生成”按钮和显示连接状态的指示（如“已连接”或“连接中断”）。

“数据生成”按钮逻辑：

点击流程：用户在项目卡片上点击“数据生成”后，前端触发事件并调用后端接口：

POST /api/projects/{projectId}/open_comfy

请求路径参数 projectId 为该项目的 ID。

后端处理：后端接到请求后，执行以下逻辑：

查询 ComfyUI 服务记录表（例如 comfyui_services 表）中是否存在当前用户（从 token 获取）与该项目对应的服务记录。

如果存在且状态为“在线”，直接返回该服务的访问信息（例如端口号和 URL）。

如果不存在记录或现有服务状态为“离线”：

如果存在旧服务进程（如端口被占用），后端先杀掉旧进程并删除记录。

后端选择一个可用端口（如从预定义端口池或递增策略获取），通过系统命令（例如 subprocess.Popen）启动新的 ComfyUI 服务实例（通常命令带上端口参数，如 comfyui --port {port}），并记录在数据库中：

{ service_id, user_id, project_id, port, status: "在线", last_heartbeat: 当前时间 }

启动后，后端返回新服务的访问地址或端口号给前端。

返回信息：后端返回的数据示例：

{
  "code": 0,
  "data": { "comfy_url": "http://localhost:8200" }
}

前端根据返回的 comfy_url 打开 ComfyUI 界面（可在新标签页打开该地址）。

前端跳转：前端收到返回地址后跳转至 ComfyUI 服务页面，让用户开始在 ComfyUI 界面内进行数据生成操作。

错误与状态提示：

如果后端启动服务失败或返回错误（例如端口冲突、服务启动异常等），前端应显示错误提示，并可让用户重试。

当 ComfyUI 服务已启动并且前端打开页面时，项目卡片上的状态应显示“已连接”。若服务停止或中断，状态显示为“连接中断”。

多用户与单服务约束：

单项目单服务：每个用户对每个项目只能启动一个 ComfyUI 服务。如果用户重复点击“数据生成”，前端将复用已有的服务（无重复启动）。

可见性：系统中所有用户都可以看到所有项目，但“数据生成”按钮只对服务拥有者或当前用户可用。即，如果某项目的 ComfyUI 服务由用户A启动，则用户B在该项目卡片点击“数据生成”时，后端会拒绝操作并提示权限不足。前端可通过禁用按钮或弹窗提示方式告知用户。

后端权限校验：后端接口 POST /api/projects/{projectId}/open_comfy 必须验证当前用户为该 ComfyUI 服务的拥有者，否则返回 403 错误。

#### ComfyUI 服务绑定与管理

每用户独立服务：系统保证每位注册用户拥有独立的 ComfyUI 服务实例（以不同端口区分），互不冲突。

服务启动细节：

后端通过调用命令行或使用 Docker 启动 ComfyUI。例如：

subprocess.Popen(["comfyui", "--port", str(port)])

启动后，ComfyUI 监听指定端口（如 http://localhost:8200）。

后端在数据库中记录该服务的端口号和当前状态。

握手机制：

后端定期（如每 30 秒）向所有已记录的 ComfyUI 服务发送健康检查请求。假设 ComfyUI 暴露了健康检查接口（例如 GET http://localhost:{port}/api/health 返回 200 表示在线）。

如果响应正常，后端将该服务记录的 status 更新为“在线”；如果请求失败或超时，则更新为“离线”。

前端通过定时拉取或 WebSocket 接收后端的状态更新，实时在项目卡片上显示服务状态（“已连接”或“连接中断”）。

端口管理：

新启动服务时，后端应检查所选端口是否空闲，避免冲突。若端口已被占用，可重新选择其他端口。

数据库中 comfyui_services 表结构示例：

service_id | user_id | project_id | port | status  | last_heartbeat
-----------|---------|------------|------|---------|----------------
1          | 10      | 123        | 8200 | 在线    | 2025-09-28 10:05:00

若服务异常终止，后端可在握手失败后停止检测并删除该记录，释放端口。

完整流程示意：

用户点击项目卡片上的“数据生成”。

前端调用后端 POST /api/projects/{id}/open_comfy。

后端查询 ComfyUI 服务记录：

若存在在线服务，直接返回该服务信息；

否则，如果存在旧服务进程，先杀掉并删除记录；然后选择新端口，启动 ComfyUI 服务，并记录在表中。

后端将服务地址（含端口）返回给前端。

前端打开 ComfyUI 页面，用户开始在其中使用自定义的 Nano Banana 节点等生成任务。

后端定期握手更新服务状态，前端实时显示连接状态。

每次生成完成后，ComfyUI 通过回调通知后端，后端将生成记录存入数据库（用于统计模块使用）。

### 数据统计模块

统计目标：对平台的“数据生成”操作进行量化统计，方便管理员或用户查看各项目、各用户的使用情况。统计可按时间（天）、项目、用户等维度进行分析。

字段定义与日志结构：系统维护一张日志表(GenerationLogs)，用于记录每次生成尝试的信息。字段示例如下：

log_id：日志主键

user_id：执行生成的用户ID

project_id：所属项目ID

timestamp：生成发生的日期时间

status：生成结果状态（如“成功”或“失败”）

concurrent_id：可选字段，用于标识并发任务（若同一时间存在多线程/多进程并发生成，则为相同ID）

details：可选字段，如错误信息或耗时等

日志收集流程：

用户在 ComfyUI 界面执行生成操作，每个任务完成后，ComfyUI 服务通过 HTTP 调用后端接口（例如 POST /api/logs），提交生成结果。请求体示例：

{ "user_id": 10, "project_id": 123, "timestamp": "2025-09-28T10:15:00", "status": "成功", "concurrent_id": 456 }

后端接收后，将该条记录插入 GenerationLogs 表。对于失败的生成，也做类似记录，status 字段为“失败”。

如果存在并发调用，前端或 ComfyUI 可为它们分配相同的 concurrent_id，日志表中会出现多条时间相近但拥有相同 concurrent_id 的记录。

统计接口：

GET /api/stats?dimension=<维度>&start_date=<开始>&end_date=<结束>

参数：

dimension：可选值如 day（按天）、project、user 等。

start_date、end_date：指定统计时间范围（格式如 YYYY-MM-DD）。

后端根据参数从 GenerationLogs 聚合数据，并返回统计结果。例如按天统计时返回每天的生成次数：

{ 
  "code": 0,
  "data": [
    { "date": "2025-09-26", "count": 50 },
    { "date": "2025-09-27", "count": 80 },
    ...
  ]
}

GET /api/logs?user_id=<>&project_id=<>&start=<>&end=<>：

返回符合条件的日志列表，用于在前端表格中显示详细记录。

示例返回：

{
  "code": 0,
  "data": [
    { "timestamp": "2025-09-28 10:15:00", "user": "张三", "project": "项目A", "status": "成功" },
    { "timestamp": "2025-09-28 10:20:30", "user": "李四", "project": "项目B", "status": "失败" },
    ...
  ]
}

GET /api/export?dimension=<>&start_date=<>&end_date=<>：

返回一个 Excel 文件流，用于下载当前统计结果的数据。后端根据同样的筛选条件查询统计数据，并使用 Pandas 或 openpyxl 等库生成 Excel，返回给前端触发下载。

前端展示：

统计看板提供筛选控件，用户可选择统计时间范围、项目和用户等维度。

默认显示一个折线图：X 轴为“日期”，Y 轴为“当日生成次数”。折线图背景可使用渐变色增强视觉效果。

折线图下方是数据表格，列字段包括：用户名、项目名、生成次数、失败次数等（并发调用记录为多行）。

点击“导出”按钮时，前端调用后端 export 接口并下载生成的 Excel 文件。

### 服务器监控模块

功能说明：提供后台服务器的资源使用监控（仅读），包括 CPU、内存、交换区和磁盘使用率。移除所有开关机或重启按钮，仅保留监控功能。

监控项：

CPU使用率：百分比表示（如 23.5%）

内存使用率：百分比或已用/总内存（MB/GB）

交换区（SWAP）使用率

磁盘使用率：例如根分区已用百分比

数据采集：

后端使用 psutil 等系统监控库实时读取各项指标：

import psutil
cpu = psutil.cpu_percent()
memory = psutil.virtual_memory().percent
swap = psutil.swap_memory().percent
disk = psutil.disk_usage('/').percent

后端提供接口 GET /api/server/stats，返回 JSON，例如：

{
  "code": 0,
  "data": {
    "cpu": 23.5,
    "memory": 45.2,
    "swap": 12.3,
    "disk": 67.8
  }
}

前端展示：

仪表盘界面定时（例如每 5-10 秒）调用 /api/server/stats，并用图表或进度条显示最新数据。例如以环形图或线性图展示。

界面上只保留监控数值展示，去掉所有开关机或重启按钮。

### 权限管理

ComfyUI 服务访问权限：

用户只能访问自己启动的 ComfyUI 服务。前端在项目卡片上对“数据生成”按钮进行权限控制：若当前用户不是该服务的所有者，则禁用按钮并提示“无权限操作”。

后端在 open_comfy 等接口中进行用户校验：接口操作仅允许请求中的用户ID与服务记录中的 user_id 匹配，否则返回 403 错误。

项目访问权限：

所有用户可查看所有项目列表（只读）。如果需要更细粒度权限，可在项目表中记录 owner_user_id 并限制非所有者无法修改该项目（如修改名称、备注等操作）。

接口安全：

所有敏感接口（创建项目、启动服务、数据生成日志上传、导出统计等）都需要先登录认证。前端每次请求附带 JWT Token，后端通过 FastAPI 安全依赖检查后再执行业务逻辑。

用户权限不足时，后端返回 401/403 错误，前端捕获后提示用户（如弹窗显示“无操作权限”）。

### 前后端数据交互细节

请求与返回示例：

用户注册：

请求：POST /api/auth/register，请求体：{ "username": "zhangsan", "email": "a@b.com", "password": "xxx" }。

返回：{ "code": 0, "message": "注册成功" }。

用户登录：

请求：POST /api/auth/login，请求体：{ "username": "zhangsan", "password": "xxx" }。

返回：{ "code": 0, "data": { "token": "eyJhbG...", "userId": 10 } }。

创建项目：

请求：POST /api/projects，请求体：{ "name": "项目A", "code": "PRJ001", "note": "测试项目" }，Header 中 Authorization: Bearer <token>。

返回：{ "code": 0, "data": { "id": 123, "name": "...", "code": "...", "create_time": "2025-09-28 10:00:00" } }。

打开 ComfyUI 服务：

请求：POST /api/projects/123/open_comfy。

返回成功：{ "code": 0, "data": { "comfy_url": "http://localhost:8200" } }；若失败：{ "code": 1, "message": "启动 ComfyUI 失败：端口已被占用" }。

获取统计：

请求：GET /api/stats?dimension=day&start_date=2025-09-20&end_date=2025-09-28。

返回：{ "code": 0, "data": [ { "date": "2025-09-20", "count": 100 }, ... ] }。

导出统计：

请求：GET /api/export?start_date=...&end_date=...。

返回：Excel 文件下载流，文件名如 stats_20250920_20250928.xlsx。

状态更新策略：

前端在发起涉及后台数据的操作后，根据接口返回的 code 判断成功失败并更新页面状态。例如项目创建成功后刷新项目列表；服务启动后展示“已连接”；生成日志上传成功后刷新统计界面。

后端在关键操作后应返回足够的上下文数据（如新创建的记录ID、时间戳、服务端口等），供前端及时更新页面。

通常后端返回格式遵循统一规范（例如 { code: 0, data: {...}, message: "成功" }），前端可统一处理并显示 message。

### 用户操作流程示意

以下以用户点击“数据生成”触发的数据生成流程为例，描述前后端完整联动过程（文字流程图）：

用户（前端）→ 点击项目卡片上的“数据生成”按钮
→ 前端 发送 POST /api/projects/{项目ID}/open_comfy 请求
→ 后端 查询该用户与项目对应的 ComfyUI 服务记录
   → 记录存在且状态在线：直接返回服务的访问地址
   → 记录不存在或离线：
         1. 如果存在旧进程，后端杀掉旧的 ComfyUI 进程，并删除记录
         2. 后端选择一个空闲端口，启动新的 ComfyUI 服务进程（绑定该用户与项目）
         3. 后端在数据库插入新服务记录，状态置为“在线”
         4. 后端返回新服务的访问地址
→ 前端 根据返回的地址（如 http://localhost:8200）打开 ComfyUI 界面（新标签页或 iframe）
→ 用户在 ComfyUI 界面内运行自定义的 Nano Banana 节点等进行生成任务
→ ComfyUI 服务完成生成后，通过 HTTP 回调（例如 POST /api/logs）将结果和状态反馈给后端
→ 后端 接收生成结果，记录到日志表（包含用户、项目、时间、结果等）
→ 前端可以刷新统计页面，通过 GET /api/stats 和 GET /api/logs 接口获取最新数据，更新图表和表格显示

### 后端架构与代码生成支持

后端基于现有 vue-fastapi-admin-main 框架改造，作为前端 Art-Design-Pro 与 ComfyUI 之间的桥梁。主要包括以下部分：
- 数据库设计：包含 users 表（用户信息）、projects 表（项目信息）、comfyui_services 表（服务状态）、generation_logs 表（生成记录）。
- FastAPI 服务：为前端提供上述功能的 RESTful API 接口，使用异步数据库连接（如 asyncpg + SQLAlchemy/SQLModel）实现高性能交互。
- 接口文档：可通过 /docs 访问自动生成的 Swagger 接口文档，方便查看 API 细节。
- 代码生成：以上模块和接口描述清晰地阐明了各功能点的职责、调用顺序和数据结构，使得自动化工具（如 Cursor 模型）能够根据文档推理生成相应的前后端代码骨架。例如，根据接口定义自动生成请求参数的 Pydantic 模型、Vue3 的 Axios 请求代码、数据库操作逻辑等。

以上文档各部分均已详细描述功能模块的逻辑结构、前后端交互细节和操作流程，并通过列表和文字流程图示形式加以说明。文档结构清晰，层次分明，旨在为 Cursor 模型自动生成前后端改造代码提供充分的信息支持。
